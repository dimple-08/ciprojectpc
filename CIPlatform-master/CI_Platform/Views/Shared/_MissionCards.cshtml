@using CI_Platform.Entity.ViewModels
@model MissionLandingModel
@{
    PaginationModel pagination = new PaginationModel();

    int pageNo = 0;

    if (ViewBag.Pagination != null)
    {
        pagination = ViewBag.Pagination;
        pageNo = pagination.CurrentPage;
    }
}

<link rel="stylesheet" href="~/css/index.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.2/umd/popper.min.js" integrity="sha512-2rNj2KJ+D8s1ceNasTIex6z4HWyOnEYLVC3FigGOmyQCZc2eBXKgOxQmo3oKLHyfcj53uz4QMsRCWNbLd32Q1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src=~/js/custom.js></script>
<script>

    


                


            
    








</script>

<style>
    @@charset "UTF-8";

    :root {
        --star-size: 28px;
        --star-color: #ddd;
        --star-background: #f8d441;
    }

    .Stars {
        --percent: calc(var(--rating) / 5 * 100%);
        display: inline-block;
        font-size: var(--star-size);
        font-family: Times;
        line-height: 1;
    }

        .Stars::before {
            content: "★★★★★";
            letter-spacing: 3px;
            background: linear-gradient(90deg, var(--star-background) var(--percent), var(--star-color) var(--percent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .missionClosedbtn {
    border-top-right-radius: 18px;
    left: 0;
    opacity: 0.45;
    color: white;
    border-color: transparent;
    border-bottom-right-radius: 18px;
    background-color: red;
    padding: 0 6px;
    width: 7.5rem;
    height: 2rem;

}

.missionAppliedbtn{
    border-top-right-radius: 18px;
    left: 0;
    opacity: 0.45;
    color: white;
    border-color: transparent;
    border-bottom-right-radius: 18px;
    background-color: green;
    padding: 0 6px;
    width: 7.5rem;
    height: 2rem;
}

</style>

<div>


    @*LIST VIEW AND GRID VIEW8*@


    <div id="toggle-container" class="d-flex justify-content-end mt-2">

        <p class="me-auto ms-1">Explore @ViewBag.ToalMissionCount Missions</p>


        <div class="dropdown mt-1 me-2">
            <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Sort By
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" onclick="LoadMission('','Newest')">Newest first</a></li>
                <li><a class="dropdown-item" onclick="LoadMission('','Oldest')">Oldest First</a></li>
                <li><a class="dropdown-item" onclick="LoadMission('','lowest')">lowest Seats</a></li>
                <li><a class="dropdown-item" onclick="LoadMission('','highest')">highest Seats</a></li>
            </ul>
        </div>
        <button class="btn btn-grid"><i class="fa fa-th-large "></i></button>
        <button class="btn btn-list"><i class="fa fa-bars"></i></button>

    </div>
    <br>

    <div class="container grid-container">
        <div class="row">
              @{
                            var userid = Context.Session.GetString("UserId");
               }
            @foreach (var item in Model.Missions)
            {
              
                <div class=" item col-12 col-md-6 col-lg-4">
                    <div class="card">
                        <img src="~/Images/Grow-Trees-On-the-path-to-environment-sustainability-1.png" class="card-img-top" alt="...">
                        @if(item.Deadline < @DateTime.Now)
                        {
                        
                            <button class="missionClosedbtn position-absolute" type="button">Closed</button>
                        }
                        @if(userid != null)
                        {
                           if(Model.MissionApplications.FirstOrDefault(m => m.MissionId == item.MissionId) != null)
                           {
                            
                            <button class="missionAppliedbtn position-absolute" type="button">Applied</button>
                           }

                        }
                        
                        
                        <button class="location-btn " type="button"><img src="~/images/pin.png" class="d-inline me-1" /><p class="d-inline">@item.City.Name</p></button>
                        <div hidden><img src="~/images/pin.png" alt=""></div>
                        

                        @if (userid != null)
                        {
                            @if (Model.FavMissionData.Where(FM => FM.MissionId == item.MissionId).FirstOrDefault() != null)
                            {
                                <button class="like-btn " id="@item.MissionId"  onclick="addtofav(@item.MissionId,@userid)">
                                    @*@item.MissionId,@userid*@
                                    <i class="bi bi-heart-fill" style="color:red;" id="heart"></i>
                                </button>
                            }
                            else
                            {
                                <button class="like-btn" id="@item.MissionId"  onclick="addtofav(@item.MissionId,@userid)">
                                    <i class="bi bi-heart" style="color:white;" id="heart"></i>

                                </button>
                            }


                        }
                        else
                        {
                            <button class="like-btn" id="@item.MissionId" onClick="pleaseLogin()">
                                <img src="~/images/heart.png" alt="">
                            </button>

                        }


                        @if (userid != null)
                        {
                            <button type="button" class="eye-btn" data-bs-toggle="modal" data-bs-target="#exampleModal"><img src="~/Images/add1.png" class="mt-2 me-2 eye-button-volunteering" /></button>
                            <!-- Modal -->
                            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel">Recommend To</h5>
                                            <span class="ms-5" id="sent" style="color:green; position:absolute;right:15%"> </span>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="spinner-border text-success d-none" role="status" id="emailLoader">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                        <div class="modal-body" style=" width: auto; max-height : 300px; overflow-y: scroll; overflow-x: hidden;" id="emaillist">
                                            @foreach (var user in Model.Users)
                                            {
                                                <button class="dropdown-item recomandtouser ms-3 d-flex mt-2" value="@user.Email" name="@user.FirstName" onclick="recomand('@user.Email',@item.MissionId)" id="sent">
                                                    <div>
                                                        <img src="~/Images/volunteer1.png" height="35px" width="35px" class="rounded-circle me-3        />
                                        </div>
                                        <div class="ms-2">

                                                        @user.FirstName : @user.Email
                                                    </div>
                                                    <div class="btn btn-primary me-1" style="position:absolute; right:6px;">
                                                        Send Email
                                                    </div>
                                                </button>

                                            }
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <button type="button" class="eye-btn me-1" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="pleaseLogin()"><img src="~/Images/add1.png" class="mt-2 me-2 eye-button-volunteering" /></button>
                        }

                        <button class="category-btn position-absolute">@item.Theme.Title</button>
                        <div class="card-body p-0 mt-3">
                            <h5 class="card-title mt-1 ps-3 pe-3"> @item.Title </h5>
                            <p class="card-text ps-3 pe-3">@item.ShortDescription</p>
                            <div class="d-flex ps-3 pe-3">
                                <span class="me-auto fs-6">@item.OrganizationName</span>
                                <span class="me-2">
                                    @if (Model.MissionRatings.Where(MR => MR.MissionId == item.MissionId) != null)
                                    {
                                        var ratingTotal = Model.MissionRatings.Where(MR => MR.MissionId == item.MissionId).ToList();
                                        var prevRating = Model.MissionRatings.FirstOrDefault(pr => pr.MissionId == item.MissionId);

                                        float rat = 0;
                                        float sum = 0;
                                        @foreach (var r in ratingTotal)
                                        {
                                            sum = (int)(sum + (r.Rating));
                                        }
                                        if (ratingTotal.Count() == 0)
                                        {
                                            rat = 0;
                                        }
                                        else
                                        {
                                            rat = sum / ratingTotal.Count();

                                        }
                                        if (prevRating != null)
                                        {
                                            ViewBag.avgrating = rat;
                                        }
                                        else
                                        {
                                            ViewBag.avgrating = 0;
                                        }
                                        var TotalRatedByUser = ratingTotal.Count();

                                        <div class="Stars" style="--rating: @ViewBag.avgrating;"></div>

                                        @* int count = 0;

                                            @for (var i = 1; i <= rat; i++)
                                            {
                                            <i class="bi bi-star-fill"></i>
                                            count++;
                                            }
                                            @for (var k = count + 1; k <= 5; k++)
                                            {
                                            <i class="bi bi-star"></i>
                                            }*@

                                    }
                                    @* else
                                        {
                                        <i class="bi bi-star" id="1"></i>
                                        <i class="bi bi-star" id="2"></i>
                                        <i class="bi bi-star" id="3"></i>
                                        <i class="bi bi-star" id="4"></i>
                                        <i class="bi bi-star" id="5"></i>

                                        }*@
                                    @*<span class="fa fa-star checked"></span>
                                        <span class="fa fa-star checked"></span>
                                        <span class="fa fa-star checked"></span>
                                        <span class="fa fa-star"></span>
                                        <span class="fa fa-star"></span>*@
                                </span>
                            </div>
                            <br />


                            @if (item.MissionType == "0")  // timebased = 0
                            {
                                <button class="date-btn position-absolute">From @item.StartDate.Value.ToShortDateString()  until @item.EndDate.Value.ToShortDateString()</button>
                                <hr class="position-relative">
                                <div class="d-flex flex-row justify-content-between ps-3 pe-3">
                                    <div class="d-flex flex-row align-items-center">
                                        <img src="~/Images/Seats-left.png" alt="" class="" height="30" width="30">
                                        <div class="d-flex flex-column ms-2">
                                            <p class="d-inline mb-0 pt-2">@item.Availability</p>
                                            <p class="seat">Seats Left</p>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-row align-items-center">
                                        <img src="~/Images/deadline.png" height="33" width="33" alt="">
                                        <div class="d-flex flex-column ms-2">
                                            <p class="d-inline mb-0 pt-2">@item.Deadline.Value.ToShortDateString() </p>
                                            <p class="seat">Deadline</p>
                                        </div>
                                    </div>
                                </div>
                            }
                            else if (item.MissionType == "1")
                            {
                                @foreach (var goal in Model.GoalMission)
                                {
                                    @if (goal.MissionId == item.MissionId)
                                    {
                                        <button class="date-btn position-absolute">@goal.GoalObjectiveText</button>
                                    }

                                }

                                <hr class="position-relative">
                                <div class="d-flex flex-row justify-content-between ps-3 pe-3">
                                    <div class="d-flex flex-row align-items-center">
                                        <img src="~/Images/Seats-left.png" alt="" class="" height="30" width="30">
                                        <div class="d-flex flex-column ms-2">
                                            <p class="d-inline mb-0 pt-2">@item.Availability</p>
                                            <p class="seat">Seats Left</p>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-row align-items-center" style="width: 50%;">
                                        <img src="~/Images/mission.png" height="33" width="33" alt="">
                                        <div class="d-flex flex-column ms-2 " style="margin-top:9%; width: 80%;">
                                            <div class="progress">
                                                <div id="one" class="progress-bar" style="background-color: #F88634 !important;width: 60%;" role="progressbar" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                            <p class="seat mt-2">8000 achieved</p>
                                        </div>

                                    </div>
                                </div>
                            }



                            <hr class="position-relative mb-4" />
                            @if (userid != null)
                            {
                                @if(Model.MissionApplications.FirstOrDefault(m => m.MissionId == item.MissionId)!=null)
                                {
                                    <a class="apply-button  d-flex justify-content-center mx-auto my-auto mb-4" href="/LandingPage/MissionVolunteering?MissionId=@item.MissionId">View Details<i class="bi bi-arrow-right ms-2"></i></a>
                                }
                                else
                                {
                                     <a class="apply-button  d-flex justify-content-center mx-auto my-auto mb-4" href="/LandingPage/MissionVolunteering?MissionId=@item.MissionId">Apply<i class="bi bi-arrow-right ms-2"></i></a>
                                }

                           }
                            else
                            {
                                <a class="apply-button  d-flex justify-content-center mx-auto my-auto mb-4" href="/User/Login">Login First<i class="bi bi-arrow-right ms-2"></i></a>
                            }
                        </div>
                    </div>
                </div>
            }






        </div>
    </div>
</div>

<div class="container-fluid mt-3">
    @if (pagination.TotalPages > 0)
    {
        <ul class="pagination justify-content-center">
            @if (pagination.CurrentPage > pagination.StartPage)
            {
                <li class="page-item">
                    <a class="page-link" onClick="LoadMission(@pagination.StartPage)">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" onClick="LoadMission(@pagination.CurrentPage - 1)">Previous</a>
                </li>

            }

            @for (var pg = pagination.StartPage; pg <= pagination.EndPage; pg++)
            {
                <li class="page-item @(pg == pagination.CurrentPage ? "active" : "")">
                    <a class="page-link" onClick="LoadMission(@pg)">@pg</a>
                </li>
            }

            @if (pagination.CurrentPage < pagination.TotalPages)
            {
                <li class="page-item">
                    <a class="page-link" onClick="LoadMission(@pagination.CurrentPage + 1)">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" onClick="LoadMission(@pagination.TotalPages)">Last</a>
                </li>
            }
        </ul>
    }
</div>

